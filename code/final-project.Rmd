---
title: "final-project"
author: "Murphy John"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(stringr)
library(psych)
library(gmodels)
library(survival)
library(survminer)
```


```{r}
# load data
seer <- readRDS("data/processed/seer.rds")
attach(seer)
```


```{r}
# Table 1: Clinicopathological Characteristics by Breast Cancer Subtype
# (unadjusted associations between covariates and exposure)

## agecat
CrossTable(agecat, subtype, prop.r = FALSE, prop.c = TRUE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE)

## race
CrossTable(racecat, subtype, prop.r = FALSE, prop.c = TRUE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE)

## marriage status
CrossTable(marriage_status, subtype, prop.r = FALSE, prop.c = TRUE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE)

## N stage
CrossTable(n_stage, subtype, prop.r = FALSE, prop.c = TRUE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE)

## M stage
CrossTable(m_stage, subtype, prop.r = FALSE, prop.c = TRUE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE)

## grade
CrossTable(grade, subtype, prop.r = FALSE, prop.c = TRUE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE, useNA = "always")

## radiation
CrossTable(radiation, subtype, prop.r = FALSE, prop.c = TRUE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE)

## chemotherapy
CrossTable(chemotherapy, subtype, prop.r = FALSE, prop.c = TRUE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE)

## surgery
CrossTable(surgery, subtype, prop.r = FALSE, prop.c = TRUE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE)
```

```{r}
# Table 2: Clinicopathological Characteristics by survival
# (Unadjusted associations between covariates and survival) also median survival
# this is univariate cox ph model
# Risk factors for OS according to the Cox proportional hazards regression model.

## agecat
survfit(Surv(survival_months, survival_status)~agecat)
summary(survfit(Surv(time = survival_months, event = survival_status) ~ agecat), times = c(12, 60, 120))
survdiff(Surv(time = survival_months, event = survival_status) ~ agecat)

## race
survfit(Surv(survival_months, survival_status)~racecat)
summary(survfit(Surv(time = survival_months, event = survival_status) ~ racecat), times = c(12, 60, 120))
survdiff(Surv(time = survival_months, event = survival_status) ~ racecat)

## marriage status
survfit(Surv(survival_months, survival_status)~marriage_status)
summary(survfit(Surv(time = survival_months, event = survival_status) ~ marriage_status), times = c(12, 60, 120))
survdiff(Surv(time = survival_months, event = survival_status) ~ marriage_status)

## N stage
survfit(Surv(survival_months, survival_status)~n_stage)
summary(survfit(Surv(time = survival_months, event = survival_status) ~ n_stage), times = c(12, 60, 120))
survdiff(Surv(time = survival_months, event = survival_status) ~ n_stage)

## M stage
survfit(Surv(survival_months, survival_status)~m_stage)
summary(survfit(Surv(time = survival_months, event = survival_status) ~ m_stage), times = c(12, 60, 120))
survdiff(Surv(time = survival_months, event = survival_status) ~ m_stage)

## grade
survfit(Surv(survival_months, survival_status)~grade)
summary(survfit(Surv(time = survival_months, event = survival_status) ~ grade), times = c(12, 60, 120))
survdiff(Surv(time = survival_months, event = survival_status) ~ grade)

## radiation
survfit(Surv(survival_months, survival_status)~radiation)
summary(survfit(Surv(time = survival_months, event = survival_status) ~ radiation), times = c(12, 60, 120))
survdiff(Surv(time = survival_months, event = survival_status) ~ radiation)

## chemotherapy
survfit(Surv(survival_months, survival_status)~chemotherapy)
summary(survfit(Surv(time = survival_months, event = survival_status) ~ chemotherapy), times = c(12, 60, 120))
survdiff(Surv(time = survival_months, event = survival_status) ~ chemotherapy)

## surgery
survfit(Surv(survival_months, survival_status)~surgery)
summary(survfit(Surv(time = survival_months, event = survival_status) ~ surgery), times = c(12, 60, 120))
survdiff(Surv(time = survival_months, event = survival_status) ~ surgery)
```


```{r}
# create a dataset in counting process format
seer.cpfull <- survSplit(seer, cut=seer$survival_months[seer$survival_status==1],
                     end="survival_months",event="survival_status", start="start")
# remove NA because the model will do this anyways
seer.cp <- na.omit(seer.cpfull)
```

```{r}
# check the correlation between schoenfeld residuals and ranked survival times
library(survival)
library(dplyr)

# run the cox ph model
# this will be in Table 2 as multivariate analysis
model <- coxph(
  Surv(survival_months, survival_status) ~ 
    relevel(factor(subtype), ref = '0') +
    relevel(factor(agecat), ref = '0') + 
    relevel(factor(racecat), ref = '0') +
    relevel(factor(marriage_status),ref='1') + 
    relevel(factor(n_stage),ref='0') + 
    relevel(factor(m_stage),ref='0') +
    relevel(factor(grade), ref='0') +
    relevel(factor(radiation), ref='1') + 
    relevel(factor(chemotherapy), ref='1') +
    relevel(factor(surgery), ref='1'),
  data = seer, 
  method = "breslow")

summary(model)

options(scipen=999)

# Test proportional hazards assumption with Schoenfeld residuals
resid <- cox.zph(model, terms = FALSE)

# get the correlations between residuals and ranked survival times
apply(resid$y, 2, \(x) cor.test(rank(resid$time), x))
# subtype1: -0.034
# subtype2: -0.1296
# subtype3: -0.0435
# agecat1: -0.0331
# agecat2: -0.0304
# racecat1: 0.0077
# racecat2: 0.0102
# marraige_status0: 0.0043
# n_stage1: 0.0188
# m_stage: -0.0046
# grade: -0.0412
# radiation: -0.072
# chemotherapy: -0.1122
# surgery: -0.0715

cor <- apply(resid$y, 2, \(x) {
  test <- cor.test(rank(resid$time), x)  # Perform correlation test
  c(
    correlation = round(test$estimate, 3),
    p_value = round(test$p.value, 3),
    conf_low = round(test$conf.int[1], 3),
    conf_high = round(test$conf.int[2], 3)
  ) 
})

# Convert the matrix to a data frame
cor_df_all <- as.data.frame(t(cor))

# Now, we can correctly mutate and format the output
cor_df <- cor_df_all %>%
  mutate(
    Correlation = paste(correlation.cor, " (", conf_low, ", ", conf_high, ")", sep = ""),
    P_Value = as.character(p_value)
  ) %>%
  select(Correlation, P_Value)
rownames(cor_df) <- c(
  "subtype1",
  "subtype2",
  "subtype3",
  "agecat1",
  "agecat2",
  "racecat1",
  "racecat2",
  "marraige_status0",
  "n_stage1",
  "m_stage",
  "grade",
  "radiation",
  "chemotherapy",
  "surgery"
)

# table 3: Correlation between Schoenfeld residuals and ranked survival time
t3_raw <- cor_df %>%
  add_row(Correlation = "", P_Value = "", .before = 1) %>%
  add_row(Correlation = "", P_Value = "", .before = 1) %>%
  add_row(Correlation = "", P_Value = "", .before = 6) %>%
  add_row(Correlation = "", P_Value = "", .before = 6) %>%
  add_row(Correlation = "", P_Value = "", .before = 10) %>%
  add_row(Correlation = "", P_Value = "", .before = 10) %>%
  add_row(Correlation = "", P_Value = "", .before = 14) %>%
  add_row(Correlation = "", P_Value = "", .before = 14) %>%
  add_row(Correlation = "", P_Value = "", .before = 17) %>%
  add_row(Correlation = "", P_Value = "", .before = 17) %>%
  add_row(Correlation = "", P_Value = "", .before = 20) %>%
  add_row(Correlation = "", P_Value = "", .before = 20) %>%
  add_row(Correlation = "", P_Value = "", .before = 23) %>%
  add_row(Correlation = "", P_Value = "", .before = 23) %>%
  add_row(Correlation = "", P_Value = "", .before = 26) %>%
  add_row(Correlation = "", P_Value = "", .before = 26) %>%
  add_row(Correlation = "", P_Value = "", .before = 29) %>%
  add_row(Correlation = "", P_Value = "", .before = 29) %>%
  add_row(Correlation = "", P_Value = "", .before = 32) %>%
  add_row(Correlation = "", P_Value = "", .before = 32)
  

  

```

```{r}
# fit extended model and see if interaction terms are significant
# create a dataset in counting process format
seer.cpfull <- survSplit(seer, cut=seer$survival_months[seer$survival_status==1],
                     end="survival_months",event="survival_status", start="start")
# remove NA because the model will do this anyways
seer.cp <- na.omit(seer.cpfull)

# create interaction between each subtype and log time
seer.cp$subtype1_time=seer.cp$subtype1*log(seer.cp$survival_months)
seer.cp$subtype2_time=seer.cp$subtype2*log(seer.cp$survival_months)
seer.cp$subtype3_time=seer.cp$subtype3*log(seer.cp$survival_months)

options(scipen=999)
model_ext <- coxph(
  formula = Surv(
    seer.cp$start, seer.cp$survival_months, seer.cp$survival_status) ~ 
    subtype1 + subtype2 + subtype3 + 
    relevel(factor(agecat), ref = '0') + 
    relevel(factor(racecat), ref = '0') +
    relevel(factor(marriage_status),ref='1') + 
    relevel(factor(n_stage),ref='0') + 
    relevel(factor(m_stage),ref='0') +
    relevel(factor(grade), ref='0') +
    relevel(factor(radiation), ref='1') + 
    relevel(factor(chemotherapy), ref='1') +
    relevel(factor(surgery), ref='1') +
    subtype1_time + subtype2_time + subtype3_time, 
  data = seer.cp, method="breslow")

summary(model_ext)

```










